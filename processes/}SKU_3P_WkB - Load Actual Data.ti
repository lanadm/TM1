#region Prolog

#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Set Variables
#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

strCube_g = 'SKU_3P_Wkb';
strWeekCube_g = 't-weeks';
strYearCube_g = 't-yr4fy2';
strLocationCube_g = 't-strctr';
strStartWeek_g = '1';

#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Trim the parameters to eliminate leading or trailing blanks
#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

strEndWeek_g = TRIM(pEndWeek);

#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Set Process Variables
#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

strProcessName = GETPROCESSNAME();
strErrorFile = strProcessName | '_' | TIMST(NOW, '\Y\m\d') | '.csv';
strLogDirectory = CELLGETS('bpmControl','Log Directory','Value');
strLogDirectory = strLogDirectory | IF(SUBST(strLogDirectory, LONG(strLogDirectory), 1) @= '\', '', '\');
strError = strLogDirectory | strErrorFile;

#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Define Query
#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

strDataSource_g = 'TM1Data';
strQuery_g = 'Use CMS2000 ' |
'exec [spARReportingbySKU]';


#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Run Query
#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

strQuery = EXPAND(strQuery_g);

DATASOURCETYPE = 'ODBC';
DATASOURCENAMEFORSERVER = strDataSource_g;
DATASOURCENAMEFORCLIENT = strDataSource_g;
DATASOURCEQUERY = strQuery;

#Note, this query is a copy of the Load Sku_Data Actual - RSM & RSM CMS3


#endregion
#region Metadata

#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Add new LSKUS to dimension in the ORPHAN rollup. These items will need to be researched and moved to the correct consolidation.
#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


strDim = 'Lskus';
strFile = strProcessName | '_' | strDim | '_ElementsAdded.txt';
strSku = TRIM(V6);

IF(DIMIX(strDim, strSku) = 0);
    DIMENSIONELEMENTINSERT(strDim, '', strSku, 'N');
    DIMENSIONELEMENTCOMPONENTADD(strDim, 'ORPHAN', strSku, 1);
ENDIF;


#endregion
#region Data

#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# skip test stores 2021, 2011, 2003, 2031, 2022, -804
#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

IF(TRIM(V2) @= '2021');
    ITEMSKIP;
ElseIF(TRIM(V2) @= '2011');
    ITEMSKIP;
ElseIF(TRIM(V2) @= '2003');
    ITEMSKIP;
ElseIf(TRIM(V2) @= '2031');
    ITEMSKIP;
ElseIF(TRIM(V2) @= '2022');
    ITEMSKIP;
ElseIF(TRIM(V2) @= '-804');
    ITEMSKIP;
ENDIF;

#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Get translated name from cube t-yr4fy2 using Fiscal Year
#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

strFY = CELLGETS(strYearCube_g, TRIM(V0), 'Name');

#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Get translated name from cube t-weeks using Fiscal Year
#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

strWeek = CELLGETS(strWeekCube_g, TRIM(V2), strFY);

#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Get translated location number from cube t-strctr using store number
#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

strLocation = CELLGETS(strLocationCube_g, TRIM(V3), 'GP_Lctn_5-2015');
strChannel = TRIM(ARAccount);
strSku = TRIM(V6);


IF(STRLOCATION @='');
    ITEMSKIP;
ENDIF;

#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Calculate RA
#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

RA=Discount*-1;

#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Input Quantity, Gross Sales, and RA into the SKU_3P_Wkb cube
#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

CELLINCREMENTN(Quantity, strCube_g, strFY, strLocation, strSku, strWeek, 'Quantity', strChannel);
CELLINCREMENTN(GrossSales, strCube_g, strFY, strLocation, strSku, strWeek, 'Gross', strChannel);
CELLINCREMENTN(RA, strCube_g, strFY, strLocation, strSku, strWeek, 'Rtns and Allow', strChannel);

#endregion
#region Epilog




#endregion