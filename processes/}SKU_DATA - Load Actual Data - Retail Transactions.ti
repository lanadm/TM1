#region Prolog

#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Set Variables
#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

strCube_g = 'SKU_DATA';
strWeekCube_g = 't-weeks';
strYearCube_g = 't-yr4fy2';
strLocationCube_g = 't-strctr';
strCategory_g = 'Actual';

#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Trim the parameters to eliminate leading or trailing blanks
#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

strStartWeek_g = TRIM(pStartWeek);
strEndWeek_g = TRIM(pEndWeek);

#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Set the information variables including directories and names to use for logging and errors
#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

strProcessName = GETPROCESSNAME();
strErrorFile = strProcessName | '_' | TIMST(NOW, '\Y\m\d') | '.csv';
strLogDirectory = CELLGETS('bpmControl','Log Directory','Value');
strLogDirectory = strLogDirectory | IF(SUBST(strLogDirectory, LONG(strLogDirectory), 1) @= '\', '', '\');
strError = strLogDirectory | strErrorFile;

#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Query data source TM1Data using strStartWeek and strEndWeek as variables to pull the data
#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

strDataSource_g = 'TM1Data';
strQuery_g = 'Use SellingMetrics ' |
'exec [spLoadRetailSELMETRICSInTM1] %strStartWeek_g% , %strEndWeek_g%';


# >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>> #
# Set Logging
# >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>> #

strCube = strCube_g;


# >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>> #
# Define Data Source
# >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>> #

strQuery = EXPAND(strQuery_g);

DATASOURCETYPE = 'ODBC';
DATASOURCENAMEFORSERVER = strDataSource_g;
DATASOURCENAMEFORCLIENT = strDataSource_g;
DATASOURCEQUERY = strQuery;


#endregion
#region Data

numLocationID = StringToNumber( TRIM(V2) );


#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# If the Location is between 2000 & 2049, skip it. These are testing stores only
#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

IF( numLocationID >= 2000 & numLocationID <= 2049 );
    ItemSkip;
ENDIF;


# IF( TRIM( V2 ) @= '2011' );
#     ITEMSKIP;
# ENDIF;

#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Grab the Fiscal Year Name from the t-yr4fy2 cube
#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

strFY = CELLGETS(strYearCube_g, TRIM(V0), 'Name');

#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Grab the Selling Metrics Tran Type  for the SKU from the t-strctr cube
#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

strSku = CELLGETS(strLocationCube_g, TRIM(V3), 'Selling Metrics TranType');

#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Grab the full week description for the Week and Fiscal Year from the t-weeks cube
#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

strWeek = CELLGETS(strWeekCube_g, TRIM(V1), strFY);

#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Grab the Location translation for "GP_Lctn_5-2015" from the t-strctr cube
#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

strLocation = CELLGETS(strLocationCube_g, TRIM(V2), 'GP_Lctn_5-2015');

#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Grab the Selling Metrics Name for the Channel from the t-strctr cube
#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

strChannel = CELLGETS(strLocationCube_g, TRIM(V3), 'Selling Metrics Name');

IF(STRLOCATION @='');
    ITEMSKIP;
ENDIF;


CELLINCREMENTN(V5, strCube_g, strFY, strCategory_g, strLocation, strSku, strWeek, 'Selling Metrics Transactions', strChannel);

CELLINCREMENTN(V7, strCube_g, strFY, strCategory_g, strLocation, strSku, strWeek, 'Selling Metrics Sales', strChannel);

#endregion
#region Epilog



#endregion