#region Prolog

#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Set Variables
#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

strProcessName = GETPROCESSNAME();
strCube = 'RnA';
strCategory = 'Actual';

#strFiscalYear = pFiscalYear;
#strStartWeek = pStartWeek;
#strEndWeek = pEndWeek;


#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Trim the parameters to eliminate leading or trailing blanks
#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

strYear = TRIM(pFiscalYear);
strStartWeek = TRIM(pStartWeek);
strEndWeek = TRIM(pEndWeek);




strYearDim = 'YEAR';
strWeekDim = 'WEEK';
strLocationsDim = 'LOCATIONS';
strCategoryDim = 'CATEGORY';
strChannelDim = 'Lchannel';
strDiscountIDDim = 'RnA_DiscountID_SKU';
strMediaTypeDim = 'RnA_MediaType';
strVehicleDim = 'RnA_Vehicle';
strMeasuresDim = 'RnA_Measures';






#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Query data source TM1Data using pFiscalYear, pStartWeek, and pEndWeek as variables to pull the data
#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

strDataSource = 'TM1Data';

strQuery = 'select ' |
' FiscalYear, ' |
' FiscalWeek, ' |
' LocationID, ' |
' SalesChannelID, ' |
' DiscountID, ' |
' Vehicle, ' |
' MType, ' |
' Mkt_Vehicle, ' |
' Sum(PromoDiscount) as PromoDiscount, ' |
'  sum(NonPromoDiscount) as NonPromoDiscount, ' |
'  sum(GrossSales) as GrossSales ' |
'from SellingMetrics.dbo.TM1Load_RnA with (nolock) ' |
'where FiscalYear = ''%strYear%'' ' |
'AND FiscalWeek between ''%strStartWeek%'' and ''%strEndWeek%'' ' |
'group by FiscalYear, FiscalWeek, LocationID, SalesChannelID, DiscountID, Vehicle, Mtype, Mkt_Vehicle ' |
'order by DiscountID ASC ';


#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Define Data Source and run query
#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


strQuery = EXPAND(strQuery);

DATASOURCETYPE = 'ODBC';
DATASOURCENAMEFORSERVER = strDataSource;
DATASOURCENAMEFORCLIENT = strDataSource;
DATASOURCEQUERY = strQuery;


#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Define Specific dimension sort order for inserting new elements
#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

DIMENSIONSORTORDER('RnA_DiscountID_SKU','BYINPUT','ASCENDING','BYINPUT','ASCENDING');
DIMENSIONSORTORDER('RnA_Vehicle','','','BYHIERARCHY','ASCENDING');
DIMENSIONSORTORDER('RnA_MediaType','BYINPUT','ASCENDING','BYINPUT','ASCENDING');


#endregion
#region Metadata

#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Define variables
#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

vFiscalWeek = 'FY' |  subst( vFiscalYear, 3, 2 ) |  ' WK'  | FiscalWeek ;
vSalesChannelID = trim ( str ( SalesChannelID, 20, 0 ) ) ;
vVehicle = if ( Vehicle @='', 'Other', if( subst(Vehicle, 1, 26) @= '$10 off a Bone-In Half Ham', '$10 off a Bone-In Half Ham' ,Vehicle ) );
vMediaType= if ( MType @= '', 'Other', MType ) ;
vDiscountIDDesc= if ( Vehicle @= '', vDiscountID | ' - ' | 'Other', if(  subst(Vehicle, 1, 26) @= '$10 off a Bone-In Half Ham', vDiscountID| ' - ' | '$10 off a Bone-In Half Ham', vDiscountID | ' - ' | vVehicle )) ;
vSKUConsolidation= 'Total RnA SKU';
vMTypeConsolidation='Total MediaType';
vCategory='Actual';


DIMENSIONELEMENTINSERT('RnA_DiscountID_SKU','',vDiscountID,'n');
DIMENSIONELEMENTINSERT('RnA_Vehicle','',vVehicle,'n');
DIMENSIONELEMENTINSERT('RnA_MediaType','',vMediaType,'n');
DIMENSIONELEMENTINSERT('RnA_DiscountID_SKU','',vSKUConsolidation,'c');
DIMENSIONELEMENTINSERT('RnA_MediaType','',vMTypeConsolidation,'c');
DIMENSIONELEMENTCOMPONENTADD('RnA_DiscountID_SKU',vSKUConsolidation,vDiscountID,1.000000);
DIMENSIONELEMENTCOMPONENTADD('RnA_MediaType',vMTypeConsolidation,vMediaType,1.000000);

#endregion
#region Data

#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Define variables
#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

vFiscalWeek = 'FY' | subst( vFiscalYear, 3, 2 ) | ' WK' | FiscalWeek ;
vSalesChannelID = trim ( str ( SalesChannelID, 20, 0 ) ) ;
vVehicle = if ( Vehicle @='', 'Other', if( subst(Vehicle, 1, 26) @= '$10 off a Bone-In Half Ham', '$10 off a Bone-In Half Ham' ,Vehicle ) );
vMediaType = if ( MType @= '', 'Other', MType ) ;
vDiscountIDDesc= if ( Vehicle @= '', vDiscountID | ' - ' | 'Other', if(  subst(Vehicle, 1, 26) @= '$10 off a Bone-In Half Ham', vDiscountID| ' - ' | '$10 off a Bone-In Half Ham', vDiscountID | ' - ' | vVehicle )) ;
vSKUConsolidation= 'Total RnA SKU';
vMTypeConsolidation='Total MediaType';
vCategory='Actual';
vDiscount = trim(vDiscountID);
vLocation = trim(vLocationID);




CellPutN(vPromoDiscount,'RnA',vFiscalYear,vFiscalWeek,vLocation,vCategory,vSalesChannelID,vDiscount,vMediaType,vVehicle,'Promo Discount');
CellPutN(vNonPromoDiscount,'RnA',vFiscalYear,vFiscalWeek,vLocation,vCategory,vSalesChannelID,vDiscount,vMediaType,vVehicle,'Non-Promo Discount');
CellPutN(vGrossSales,'RnA',vFiscalYear,vFiscalWeek,vLocation,vCategory,vSalesChannelID,vDiscount,vMediaType,vVehicle,'Gross Sales');


ATTRPUTS(vDiscountIDDesc,'RnA_DiscountID_SKU',vDiscountID,'Description');

#endregion