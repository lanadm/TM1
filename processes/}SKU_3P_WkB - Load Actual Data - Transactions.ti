#region Prolog

#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Set Variables
#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

strCube_g = 'SKU_3P_WKb';
strWeekCube_g = 't-weeks';
strYearCube_g = 't-yr4fy2';
strLocationCube_g = 't-strctr';
strStartWeek_g = '1';
strCategory_g = 'Actual';

#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Trim the parameters to eliminate leading or trailing blanks
#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

strEndWeek_g = TRIM(pEndWeek);

#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Set Process Variables
#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

strProcessName = GETPROCESSNAME();
strErrorFile = strProcessName | '_' | TIMST(NOW, '\Y\m\d') | '.csv';
strLogDirectory = CELLGETS('bpmControl','Log Directory','Value');
strLogDirectory = strLogDirectory | IF(SUBST(strLogDirectory, LONG(strLogDirectory), 1) @= '\', '', '\');
strError = strLogDirectory | strErrorFile;

#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Define Query
#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

strDataSource_g = 'TM1Data';
strQuery_g = 'Use CMS2000 ' |
'exec [spARReportingByARAccount]';


#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Define Data Source
#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

strQuery = EXPAND(strQuery_g);

DATASOURCETYPE = 'ODBC';
DATASOURCENAMEFORSERVER = strDataSource_g;
DATASOURCENAMEFORCLIENT = strDataSource_g;
DATASOURCEQUERY = strQuery;


#endregion
#region Data

#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# skip test stores 2021, 2011, 2003, 2031, 2022, -804
#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

IF(TRIM(V2) @= '2021');
    ITEMSKIP;
ElseIF(TRIM(V2) @= '2011');
    ITEMSKIP;
ElseIF(TRIM(V2) @= '2003');
    ITEMSKIP;
ElseIf(TRIM(V2) @= '2031');
    ITEMSKIP;
ElseIF(TRIM(V2) @= '2022');
    ITEMSKIP;
ElseIF(TRIM(V2) @= '-804');
    ITEMSKIP;
ENDIF;

#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Get translated name from cube t-yr4fy2 using Fiscal Year
#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

strFY = CELLGETS(strYearCube_g, TRIM(V0), 'Name');

#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Set SKU variable to "Consumer Retail"
#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

strSku = 'Consumer Retail';

#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Get translated name from cube t-weeks using Fiscal Year
#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

strWeek = CELLGETS(strWeekCube_g, TRIM(V2), strFY);

#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Get translated location number from cube t-strctr using store number
#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

strLocation = CELLGETS(strLocationCube_g, TRIM(V3), 'GP_Lctn_5-2015');


#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Use v5 trimmed as the Channel variable
#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

strChannel = Trim(v5);

IF(STRLOCATION @='');
    ITEMSKIP;
ENDIF;

#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Input Number of Orders into the SKU_3P_WKb cube
#--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

CELLINCREMENTN(V4, strCube_g, strFY, strLocation, strSku, strWeek, 'Selling Metrics Transactions', strChannel);

#endregion